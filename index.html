<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>13e Café Loyalty – Members</title>
  <link rel="stylesheet" href="style.css" />

  <!-- 🔥 Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics-compat.js"></script>

  <!-- 📤 EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("BbD0R8hL8K8Y_KwSA"); // replace with your EmailJS user ID
    })();
  </script>

  <!-- 🔍 OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
</head>
<body>

  <header>
    <h1>13e Café Loyalty Members</h1>
    <button id="addBtn">Add</button>
<button id="settingsBtn">Settings</button>
<button id="dashboardBtn">Dashboard</button>
<button id="backupMembersBtn" style="background:#00695c;color:white;">
  💾 Backup All Members (JSON)
</button>
<button id="chooseModeBtn">Choose Mode</button>

<!-- Mode modal -->
<div id="modeModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
  <div style="background:#fff;padding:20px;border-radius:8px;text-align:center;max-width:300px;">
    <h3>Select Mode</h3>
    <button class="modeOption" data-mode="reader">Reader</button>
    <button class="modeOption" data-mode="cafe">Café</button>
    <button class="modeOption" data-mode="admin">Admin</button>
    <br><br>
    <button id="closeModeModal">Cancel</button>
  </div>
</div>

  </header>

  <!-- 🎂 Birthday banner -->
  <div id="birthdayBanner" style="display:none;">
    <p id="birthdayMessage"></p>
  </div>

  <!-- 🔎 Search + filter -->
  <div class="controls">
    <input type="text" id="searchInput" placeholder="Search by name..." />
    <select id="tierFilter">
      <option value="all">All Tiers</option>
      <option value="Bronze">Bronze</option>
      <option value="Silver">Silver</option>
      <option value="Gold">Gold</option>
    </select>
    <select id="pageSizeSelect">
      <option value="5">5 per page</option>
      <option value="10">10 per page</option>
      <option value="20">20 per page</option>
    </select>
  </div>

  <!-- 📋 Member list -->
  <div id="memberList"></div>

  <!-- ◀️ Pagination -->
  <div class="pagination">
    <button id="prevPage">Prev</button>
    <button id="nextPage">Next</button>
  </div>

  <!-- ⚡ Scripts -->
  <script src="common.js"></script>

  <!-- ✅ Hardcoded perks for rendering and email logic -->
  <script>
    window.tierBenefits = {
      Bronze: [
        "- 10% off at 13e Café",
        "- 5% off Honda motorbike service (excl. spare parts)"
      ],
      Silver: [
        "- 15% off at 13e Café",
        "- 10% off Honda service + 5% off at Millennium",
        "- 5% cashback (Rp15k/day cap)"
      ],
      Gold: [
        "- 20% off at 13e Café",
        "- 15% off Honda service + 10% off at Millennium",
        "- 🏨 Free room upgrade (every 6 months)",
        "- 💰 5% cashback (Rp30k/day cap) + new unit voucher"
      ]
    };

    window.birthdayPerks = {
      Bronze: [
        "🎂 Birthday Treat:",
        "- Free drink/snack + 30% off Honda service"
      ],
      Silver: [
        "🎂 Birthday Treat:",
        "- Free drink and snack",
        "- 50% off at Millennium",
        "- 30% off Honda service"
      ],
      Gold: [
        "🎂 VIP Birthday Package:",
        "- 🏨 Free Deluxe room for one night",
        "- 🍽️ Free Food+drink+snack combo",
        "- 💰 30% cashback (Rp30k/day cap)",
        "- 🍽️ Free VIP lounge access at 13e Café",
        "- 🎁 Optional Free birthday gift delivered to home"
      ]
    };
  </script>

  <script src="index-details.js"></script>

  <!-- 🔐 Auth bootstrap -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      firebase.auth().onAuthStateChanged(user => {
        if (user) {
          console.log("✅ Using existing sign-in:", user.email || user.uid);
        } else {
          const savedMode = localStorage.getItem("mode");
          if (savedMode === "reader") {
            firebase.auth().signInAnonymously()
              .then(() => console.log("✅ Signed in anonymously for Reader mode:", firebase.auth().currentUser.uid))
              .catch(err => console.error("❌ Anonymous auth error:", err));
          } else {
            console.warn("No auth session found — please log in manually.");
          }
        }
      });
    });

    async function validateModeServer(mode, password) {
  const response = await fetch("/.netlify/functions/validateMode", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode, password })
  });

  const result = await response.json();
  if (result.success) {
    localStorage.setItem("mode", result.mode);
    localStorage.setItem("authToken", result.token); // save token
    alert(`✅ Logged in as ${result.mode}`);
    location.reload();
  } else {
    alert(`❌ ${result.message}`);
  }
}

  </script>

</body>
</html>
